# 云服务系统容量预测

#### 常用术语

1. **系统容量与系统容量预估**：系统容量指系统所能承受的最大访问量，而系统容量预估则是在峰值流量到达之前系统。

   QPS = 总请求数 / 进程总数 / 请求时间

2. **QPS**：QPS,Query Per Second , 每秒查询量。在分布式系统中QPS的定义是，单个进程每秒请求服务器的成功次数。

3. **UV**：Unique Visitor ， 独立访问数量，指一定时间范围内站点访问的IP数量。同一IP多次访问站点只计算一次。

4. **PV**：Page View , 页面访问量，指一定时间范围内打开或刷新页面的次数。

   - 可以用pv估算带宽。

      具体的计算公式是：网站带宽= PV /统计时间（换算到S）*平均页面大小（单位KB） *8

     假设网站的平均日PV：10w 的访问量，页面平均大小0.4 M 。

       　　　 网站带宽 = 10w / （24 *60 * 60）* 0.4M * 8 =3.7 Mbps

     　　　	在实际的网站运行过程中，我们的网站必须要在峰值流量时保持正常的访问，假设，峰值流量是平均流量的5倍，按照这个计算，实际需要的带宽大约在 3.7 Mbps * 5=18.5 Mbps 。

   - 可以用pv估算并发。

     具体的计算公式是：并发连接数 = PV / 统计时间 * 页面衍生连接次数 * http响应时间 * 因数 / web服务器数量；

     页面衍生连接次数: 一个页面请求，会有好几次http连接，如外部的css, js,图片等,这个根据实际情况而定。

     http响应时间: 平均一个http请求的响应时间，可以使用1秒或更少。

     因数: 峰值流量 和平均流量的倍数，一般使用5 ,最好根据实际情况计算后得出。

     10wPV的并发连接数： (100000PV / 86400秒 * 50个派生连接数 * 1秒内响应 * 5倍峰值) / 1台Web服务器 = 289 并发连接数

     所以，如果我们能够测试出单机的并发连接数，和 日pv 数，那么我们同样也能估算出需要web的服务器数量。

     

#### 场景预估

云服务的主要功能模块包括相册、联系人、短信、云盘、查找手机。这些模块数据主要是手机端同步到云端，然后可以在其他端访问。

数据同步方式：全量同步（第一次同步）、增量同步（非第一次同步）。手机端控制触发同步动作，点击同步按钮或者定时查询同步。



云端预分配的存储5G。

预估3个规模：10万用户量、100万用户量、1000万用户量。

一台手机：相册1024张，每张大小6M; 联系人400个，一条联系人大小1kb;短信400条，一条联系人大小8kb;云盘文件200个，一个文件大小1M;



假设一台手机每天新增30张照片，新增10个联系人，新增10条短信，保存云盘数据10个文件，手机位置数据上报1000次。新增的数据每一条增量同步一次。

**一台手机同步云端量（写数据）**：

| 模块   | 数据大小 |
| ------ | -------- |
| 相册   | 6X1024   |
| 联系人 | 2        |
| 短信   | 8        |
| 云盘   | 1024     |
| 位置   | 0.8      |
|        |          |

**web端查看数据（读数据）**：照片缩略图500kb

| 模块   | 传输数据量 |
| ------ | ---------- |
| 相册   | 0.5X1024   |
| 联系人 | 2          |
| 短信   | 8          |
| 云盘   | 1024       |
| 位置   | 0.8        |
| 总共   |            |



1. 评估总访问量

   1万用户量，web端每个模块按30的访问量，总访问量10000X30(30万)

   照片手机端同步的网络带宽= 30w / （24 *60 * 60）* 6M * 8=166 Mbps(左右)

   照片web端查看的网络带宽= 30w / （24 *60 * 60）* 0.5M * 8=13.8 Mbps(左右)

   而在实际运行中，由于缓存、网站提供下载、图片较多、网站白天夜里访问量不同等原因，这个结果可能并不是很理想。这个算法只能算是一个大概的算法。

   照片web端并发连接数= (30wPV / （24 *60 * 60） * 50个派生连接数 * 1秒内响应 * 5倍峰值) / 1台Web服务器=868个

2. 评估平均吞吐量（QPS）

   总请求数 = 总PV * 页面衍生连接数

   平均QPS = **总请求数 / 总时间**

   1万用户量，web端每个模块按30的访问量，总访问量10000X30(30万)。一天访问量，按秒计算。

   平均QPS = 30万*50/（24 *60 * 60）=173

3. 评估峰值吞吐量QPS

   这个要根据实际的业务评估，通过以往的一些营的 pv 等数据进行预估。一般情况，峰值QPS大概是均值QPS的3-5倍，日均QPS为1000，于是评估出峰值QPS为5000。

4. 评估系统、单机极限QPS

   通过压力测试，算出服务器的单机极限QPS 。通过压力测试，已经知道web层是瓶颈，则可针对web 相关的做一些调整优化，以提高web 服务器 的单机QPS 。压力测试工作中，一般是以具体业务的角度进行压力测试，关心的是某个具体业务的并发量和QPS。

5. 根据线上冗余的做决定

   需要的机器 = **峰值QPS / 单机极限QPS** 

   峰值QPS是5000，单机极限QPS是1000，线上部署3台服务器。如果扛不住，需要加多少台机器？ -> 需要额外2台，提前预留1台更好，给3台保险。



#### 数据存储

数据空间包括：数据库和文件存储	

每台手机用户云存储空间分配5G空间。



文件存储总量大小=1万*5G=10000G=9.8T

数据库现在采用mysql，按现在表设计一条数据大概占用316个字节。



1万用户量，web端每个模块按30的访问量，总访问量10000X30(30万)。

照片一天的增量数据：文件存储30 *6M * 10000=1578G=1.8T

照片一天的数据库增量数据：316个字节 *30 * 10000=90M



一天比较容量

| 用户量 | 文件存储 | 数据库 |
| ------ | -------- | ------ |
| 1万    | 1.8T     | 90M    |
| 10万   | 18T      | 900M   |
| 100万  | 180T     | 9000M  |
| 1000万 | 1800T    | 90000M |



1万用户量每天按这个增量同步（这里只是粗略给个数据，实际中不能每天还是不会这么同步照片）

| 日期   | 文件存储 | 数据库 |
| ------ | -------- | ------ |
| 第一天 | 1.8T     | 90M    |
| 第二天 | 1.8T*2   | 90M*2  |
| 第三天 | 1.8T*3   | 90M*3  |
| 第四天 | 1.8T*4   | 90M*4  |
| 第五天 | 1.8T*5   | 90M*5  |








